# ??????????????????????????????????????????????????????????????????????????????
# REND - VEILBREAKERS MONSTER RIG
# Generated by VeilbreakersRigger - The Ultimate Cutout Animation System
# 2D Sprites
# ??????????????????????????????????????????????????????????????????????????????

extends Node2D
class_name RendRig

# ??????????????????????????????????????????????????????????????????????????????
# SIGNALS
# ??????????????????????????????????????????????????????????????????????????????
signal animation_started(anim_name: String)
signal animation_finished(anim_name: String)
signal hit_frame  ## Emitted at the impact point of attacks

# ??????????????????????????????????????????????????????????????????????????????
# EXPORTS - Tweak these in the Inspector
# ??????????????????????????????????????????????????????????????????????????????
@export_category("Idle Animation")
@export var idle_breathing: bool = true
@export var breathing_speed: float = 1.2
@export var breathing_intensity: float = 0.025
@export var idle_sway: bool = true
@export var sway_speed: float = 0.8
@export var sway_intensity: float = 2.0  # degrees

@export_category("Attack Animation")
@export var attack_windup_time: float = 0.2
@export var attack_strike_time: float = 0.08
@export var attack_recovery_time: float = 0.35
@export var attack_lunge_distance: float = 50.0
@export var attack_rotation: float = -5.0  # degrees during strike

@export_category("Hit Reaction")
@export var hit_knockback: float = 25.0
@export var hit_flash_duration: float = 0.08
@export var hit_recovery_time: float = 0.25
@export var hit_flash_color: Color = Color(3.0, 3.0, 3.0)

@export_category("Death Animation")
@export var death_fall_angle: float = 75.0
@export var death_fall_time: float = 0.6
@export var death_fade_time: float = 0.5
@export var death_bounce: bool = true

# ??????????????????????????????????????????????????????????????????????????????
# INTERNAL STATE
# ??????????????????????????????????????????????????????????????????????????????
var _base_transforms: Dictionary = {}
var _is_playing: bool = false
var _current_animation: String = ""
var _animation_tween: Tween = null
var _time: float = 0.0

# ??????????????????????????????????????????????????????????????????????????????
# NODE REFERENCES
# ??????????????????????????????????????????????????????????????????????????????
@onready var _head: Sprite2D = $head

# ??????????????????????????????????????????????????????????????????????????????
# LIFECYCLE
# ??????????????????????????????????????????????????????????????????????????????

func _ready() -> void:
    _cache_transforms()

func _process(delta: float) -> void:
    _time += delta
    
    if not _is_playing:
        _apply_idle_animation()

func _cache_transforms() -> void:
    """Store initial transforms for all parts"""
    for child in get_children():
        if child is Sprite2D:
            _base_transforms[child.name] = {
                "position": child.position,
                "rotation": child.rotation,
                "scale": child.scale,
            }

func _reset_to_base() -> void:
    """Reset all parts to their base transforms"""
    for child in get_children():
        if child is Sprite2D and child.name in _base_transforms:
            var base = _base_transforms[child.name]
            child.position = base["position"]
            child.rotation = base["rotation"]
            child.scale = base["scale"]
            child.modulate = Color.WHITE

# ??????????????????????????????????????????????????????????????????????????????
# IDLE ANIMATION
# ??????????????????????????????????????????????????????????????????????????????

func _apply_idle_animation() -> void:
    if idle_breathing:
        _apply_breathing()
    if idle_sway:
        _apply_sway()

func _apply_breathing() -> void:
    var breath = sin(_time * breathing_speed * TAU) * breathing_intensity
    
    for child in get_children():
        if child is Sprite2D:
            var n = child.name.to_lower()
            
            # Body parts expand/contract
            if "body" in n or "torso" in n or "chest" in n:
                child.scale.y = 1.0 + breath
                child.scale.x = 1.0 - breath * 0.3
            
            # Head bobs slightly
            elif "head" in n:
                if child.name in _base_transforms:
                    var base_pos = _base_transforms[child.name]["position"]
                    child.position.y = base_pos.y - breath * 8.0

func _apply_sway() -> void:
    var sway = sin(_time * sway_speed * TAU) * deg_to_rad(sway_intensity)
    rotation = sway

# ??????????????????????????????????????????????????????????????????????????????
# ANIMATION PLAYBACK
# ??????????????????????????????????????????????????????????????????????????????

func play_idle() -> void:
    """Return to idle state"""
    _stop_animation()
    _reset_to_base()
    _current_animation = "idle"

func play_attack() -> void:
    """Play attack animation with windup, strike, and recovery"""
    if _is_playing:
        return
    
    _start_animation("attack")
    
    var original_pos = position
    var original_rot = rotation
    
    _animation_tween = create_tween()
    _animation_tween.set_ease(Tween.EASE_OUT)
    
    # Windup - pull back and rotate
    _animation_tween.tween_property(self, "position:x", original_pos.x - attack_lunge_distance * 0.3, attack_windup_time)
    _animation_tween.parallel().tween_property(self, "rotation_degrees", attack_rotation * -0.5, attack_windup_time)
    
    # Strike - lunge forward
    _animation_tween.tween_property(self, "position:x", original_pos.x + attack_lunge_distance, attack_strike_time)\
        .set_ease(Tween.EASE_IN)
    _animation_tween.parallel().tween_property(self, "rotation_degrees", attack_rotation, attack_strike_time)
    
    # Hit frame
    _animation_tween.tween_callback(_emit_hit_frame)
    
    # Recovery - return with bounce
    _animation_tween.tween_property(self, "position:x", original_pos.x, attack_recovery_time)\
        .set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_ELASTIC)
    _animation_tween.parallel().tween_property(self, "rotation_degrees", 0.0, attack_recovery_time)\
        .set_ease(Tween.EASE_OUT)
    
    _animation_tween.tween_callback(_finish_animation.bind("attack"))

func play_hurt() -> void:
    """Play hurt reaction"""
    if _current_animation == "death":
        return
    
    _start_animation("hurt")
    
    # Flash white
    modulate = hit_flash_color
    
    _animation_tween = create_tween()
    
    # Flash recovery
    _animation_tween.tween_property(self, "modulate", Color.WHITE, hit_flash_duration)
    
    # Knockback
    var original_x = position.x
    _animation_tween.parallel().tween_property(self, "position:x", original_x - hit_knockback, hit_flash_duration * 2)
    _animation_tween.tween_property(self, "position:x", original_x, hit_recovery_time)\
        .set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_ELASTIC)
    
    _animation_tween.tween_callback(_finish_animation.bind("hurt"))

func play_death() -> void:
    """Play death animation"""
    _start_animation("death")
    
    _animation_tween = create_tween()
    
    # Fall over
    _animation_tween.tween_property(self, "rotation_degrees", death_fall_angle, death_fall_time)\
        .set_ease(Tween.EASE_IN)
    _animation_tween.parallel().tween_property(self, "position:y", position.y + 30, death_fall_time)
    
    # Bounce if enabled
    if death_bounce:
        _animation_tween.tween_property(self, "rotation_degrees", death_fall_angle - 10, 0.1)
        _animation_tween.tween_property(self, "rotation_degrees", death_fall_angle, 0.1)
    
    # Fade
    _animation_tween.tween_property(self, "modulate:a", 0.3, death_fade_time)
    
    _animation_tween.tween_callback(_finish_animation.bind("death"))

func play_special(intensity: float = 1.0) -> void:
    """Play special/charge animation"""
    if _is_playing:
        return
    
    _start_animation("special")
    
    _animation_tween = create_tween()
    
    # Pulse effect
    _animation_tween.tween_property(self, "scale", Vector2(1.0 + 0.1 * intensity, 1.0 + 0.1 * intensity), 0.15)
    _animation_tween.tween_property(self, "scale", Vector2(0.95, 0.95), 0.1)
    _animation_tween.tween_property(self, "scale", Vector2(1.0 + 0.15 * intensity, 1.0 + 0.15 * intensity), 0.2)
    
    # Flash
    _animation_tween.tween_callback(func(): modulate = Color(1.5, 1.2, 1.0))
    
    _animation_tween.tween_property(self, "scale", Vector2.ONE, 0.15)
    _animation_tween.parallel().tween_property(self, "modulate", Color.WHITE, 0.15)
    
    _animation_tween.tween_callback(_finish_animation.bind("special"))

# ??????????????????????????????????????????????????????????????????????????????
# ANIMATION UTILITIES
# ??????????????????????????????????????????????????????????????????????????????

func _start_animation(anim_name: String) -> void:
    _stop_animation()
    _is_playing = true
    _current_animation = anim_name
    animation_started.emit(anim_name)

func _stop_animation() -> void:
    if _animation_tween and _animation_tween.is_valid():
        _animation_tween.kill()
    _is_playing = false

func _finish_animation(anim_name: String) -> void:
    _is_playing = false
    animation_finished.emit(anim_name)

func _emit_hit_frame() -> void:
    hit_frame.emit()

func is_animating() -> bool:
    return _is_playing

func get_current_animation() -> String:
    return _current_animation

# ??????????????????????????????????????????????????????????????????????????????
# PART ACCESS
# ??????????????????????????????????????????????????????????????????????????????

func get_part(part_name: String) -> Sprite2D:
    """Get a specific body part sprite"""
    return get_node_or_null(part_name) as Sprite2D

func set_part_visible(part_name: String, visible: bool) -> void:
    """Show/hide a specific part"""
    var part = get_part(part_name)
    if part:
        part.visible = visible

func set_part_modulate(part_name: String, color: Color) -> void:
    """Set the color modulate of a specific part"""
    var part = get_part(part_name)
    if part:
        part.modulate = color
